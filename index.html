<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماشین حساب پیشرفته طراحی کارخانه هیپ لیچینگ مس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn.active {
            border-color: #16a34a; /* Green */
            background-color: #f0fdf4;
            color: #15803d;
        }
        .result-card {
            background-color: #f9fafb;
            border-right: 4px solid #2563eb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .result-title {
            font-weight: 600;
            color: #1f2937;
        }
        .result-value {
            font-weight: 700;
            color: #1d4ed8;
            font-size: 1.25rem;
        }
        .result-unit {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .assumption-box {
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">ماشین حساب پیشرفته طراحی کارخانه هیپ لیچینگ (مبتنی بر تولید)</h1>
            <p class="mt-2 text-lg text-gray-600">ظرفیت تولید کاتد و مشخصات کانسنگ را وارد کنید تا نیازمندی‌های پروژه محاسبه شود.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl font-bold mb-6 border-b-2 border-gray-200 pb-2 text-gray-700">۱. پارامترهای اصلی پروژه</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="cathode_production" class="block text-sm font-medium text-gray-700 mb-1">ظرفیت تولید کاتد (تن در سال)</label>
                    <input type="number" id="cathode_production" value="10000" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">عیار متوسط مس در کانسنگ (%)</label>
                    <input type="number" id="grade" value="0.8" step="0.1" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                </div>
                <div>
                    <label for="density" class="block text-sm font-medium text-gray-700 mb-1">دانسیته کانسنگ (تن بر متر مکعب)</label>
                    <input type="number" id="density" value="1.6" step="0.1" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="calculateBtn" class="bg-green-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-green-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-green-300">
                    محاسبه کن
                </button>
            </div>
        </div>
        
        <div id="assumptions" class="assumption-box mb-8">
            <h3 class="text-xl font-bold mb-4 text-amber-800">۲. مفروضات کلیدی (بر اساس استانداردهای مشاوران)</h3>
            <ul id="assumptionsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm">
                </ul>
        </div>

        <div id="results" class="bg-white p-6 rounded-xl shadow-md hidden">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-gray-200 pb-2 text-gray-700">۳. نتایج محاسبات</h2>

            <div class="border-b border-gray-200 mb-6">
                <nav class="flex flex-wrap -mb-px" id="tabs">
                    <button class="tab-btn active text-lg font-semibold py-4 px-6 border-b-4 border-transparent hover:border-gray-300 focus:outline-none" data-tab="summary">خلاصه فرآیند</button>
                    <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-4 border-transparent hover:border-gray-300 focus:outline-none" data-tab="crushing">سنگ‌شکنی و هیپ</button>
                    <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-4 border-transparent hover:border-gray-300 focus:outline-none" data-tab="sxew">کارخانه SX/EW</button>
                    <button class="tab-btn text-lg font-semibold py-4 px-6 border-b-4 border-transparent hover:border-gray-300 focus:outline-none" data-tab="consumables">مواد مصرفی</button>
                </nav>
            </div>

            <div id="tab-content-container">
                <div id="summary" class="tab-content active grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="crushing" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="sxew" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="consumables" class="tab-content grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>

    <script>
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const assumptionsList = document.getElementById('assumptionsList');
        
        const ASSUMPTIONS = {
            operatingDays: { value: 350, unit: 'روز در سال', label: 'روزهای کاری' },
            leachingRecovery: { value: 85, unit: '%', label: 'راندمان لیچینگ' },
            sxewRecovery: { value: 99.5, unit: '%', label: 'راندمان کلی SX/EW' },
            heapHeight: { value: 6, unit: 'متر', label: 'ارتفاع هیپ' },
            leachingCycle: { value: 90, unit: 'روز', label: 'چرخه لیچینگ (پاشش+استراحت)' },
            irrigationRate: { value: 8, unit: 'L/hr/m²', label: 'نرخ پاشش' },
            acidConsumption: { value: 20, unit: 'kg/ton ore', label: 'مصرف اسید (بسته به کانی‌شناسی)' },
            plsCopperGrade: { value: 3.5, unit: 'g/L', label: 'عیار مس در PLS' },
            raffinateCopperGrade: { value: 0.4, unit: 'g/L', label: 'عیار مس در رافینت' },
            currentDensity: { value: 300, unit: 'A/m²', label: 'چگالی جریان EW' },
            currentEfficiency: { value: 92, unit: '%', label: 'راندمان جریان EW' },
            cathodesPerCell: { value: 30, unit: 'عدد', label: 'کاتد در هر سلول (استاندارد)' },
            cathodeArea: { value: 1, unit: 'm²', label: 'سطح هر وجه کاتد' },
            operatingHoursCrusher: { value: 20, unit: 'ساعت در روز', label: 'ساعات کاری سنگ‌شکن' },
        };

        const formatNum = (num) => num.toLocaleString('fa-IR', { maximumFractionDigits: 1 });

        function createResultCard(title, value, unit) {
            return `
                <div class="result-card">
                    <h4 class="result-title">${title}</h4>
                    <p>
                        <span class="result-value">${formatNum(value)}</span>
                        <span class="result-unit">${unit}</span>
                    </p>
                </div>`;
        }
        
        function populateAssumptions() {
            assumptionsList.innerHTML = '';
            for (const key in ASSUMPTIONS) {
                const item = ASSUMPTIONS[key];
                const li = document.createElement('li');
                li.className = "bg-white p-2 rounded-md shadow-sm";
                li.innerHTML = `<span class="font-semibold text-gray-800">${item.label}:</span> <span class="font-bold text-green-700">${item.value} ${item.unit}</span>`;
                assumptionsList.appendChild(li);
            }
        }

        function performCalculations() {
            // 1. Get Inputs
            const targetCathodeTon = parseFloat(document.getElementById('cathode_production').value);
            const grade = parseFloat(document.getElementById('grade').value);
            const density = parseFloat(document.getElementById('density').value);

            if (isNaN(targetCathodeTon) || isNaN(grade) || isNaN(density) || targetCathodeTon <= 0 || grade <= 0 || density <= 0) {
                alert('لطفاً مقادیر ورودی معتبر وارد کنید.');
                return;
            }

            // 2. Core Calculations (Backward from Production)
            const A = ASSUMPTIONS;
            
            // Required Ore Calculation
            const totalRecovery = (A.leachingRecovery.value / 100) * (A.sxewRecovery.value / 100);
            const requiredLeachedCopper = targetCathodeTon / (A.sxewRecovery.value / 100);
            const requiredCopperInOre = targetCathodeTon / totalRecovery;
            const annualOreFeed = requiredCopperInOre / (grade / 100);
            const dailyOreFeed = annualOreFeed / A.operatingDays.value;

            // Crushing & Heap Design
            const crusherHourlyCapacity = dailyOreFeed / A.operatingHoursCrusher.value;
            const dailyOreVolume = dailyOreFeed / density;
            const totalAreaUnderLeach = (annualOreFeed / density) * (A.leachingCycle.value / A.operatingDays.value) / A.heapHeight.value;
            
            // SX/EW and Flow Rates
            const dailyCopperProductionKg = (targetCathodeTon * 1000) / A.operatingDays.value;
            const hourlyCopperProductionKg = dailyCopperProductionKg / 24;
            
            const copperExtractedPerLiter = (A.plsCopperGrade.value - A.raffinateCopperGrade.value) / 1000; // kg/L
            const plsFlowRateLPH = (hourlyCopperProductionKg / copperExtractedPerLiter); // L/hr
            const plsFlowRateM3PH = plsFlowRateLPH / 1000; // m³/hr
            
            // EW Calculation
            const requiredCurrent = (hourlyCopperProductionKg * 1000 * 2 * 96485) / (63.546 * 3600 * (A.currentEfficiency.value / 100)); // Faraday's Law
            const totalCathodeArea = requiredCurrent / A.currentDensity.value;
            const totalCathodes = Math.ceil(totalCathodeArea / (A.cathodeArea.value * 2)); // 2 sides per cathode
            const ewCells = Math.ceil(totalCathodes / A.cathodesPerCell.value);
            const cellVoltage = 2.1; // Typical voltage
            const rectifierPower = (requiredCurrent * cellVoltage * ewCells) / (totalCathodes / A.cathodesPerCell.value) / 1000; // kW, simplified to I*V_total
            const totalRectifierPower = (requiredCurrent * cellVoltage * ewCells) / 1000;
             const rectifierPowerFinal = (ewCells * A.cathodesPerCell.value * A.currentDensity.value * A.cathodeArea.value * 2 * cellVoltage) / 1000; // kW


            // Consumables
            const annualAcidTon = (annualOreFeed * A.acidConsumption.value) / 1000;
            const dailyAcidTon = annualAcidTon / A.operatingDays.value;
            
            // 3. Display Results
            document.getElementById('summary').innerHTML = 
                createResultCard('خوراک سالانه کانسنگ مورد نیاز', annualOreFeed, 'تن') +
                createResultCard('مس قابل استخراج در کانسنگ', requiredCopperInOre, 'تن در سال') +
                createResultCard('راندمان کلی فرآیند', totalRecovery * 100, '%');

            document.getElementById('crushing').innerHTML =
                createResultCard('ظرفیت ساعتی سنگ‌شکن', crusherHourlyCapacity, 'تن در ساعت') +
                createResultCard('حجم روزانه دپوی کانسنگ', dailyOreVolume, 'متر مکعب') +
                createResultCard('مساحت کل زیرسازی هیپ', totalAreaUnderLeach, 'متر مربع (هکتار: ' + formatNum(totalAreaUnderLeach/10000) + ')');

            document.getElementById('sxew').innerHTML =
                createResultCard('جریان محلول باردار (PLS)', plsFlowRateM3PH, 'متر مکعب در ساعت') +
                createResultCard('تعداد کل کاتدها', totalCathodes, 'عدد') +
                createResultCard('تعداد سلول‌های الکترووینینگ', ewCells, 'عدد') +
                createResultCard('ظرفیت رکتیفایر (تقریبی)', rectifierPowerFinal, 'کیلووات (kW)');

            document.getElementById('consumables').innerHTML =
                createResultCard('مصرف سالانه اسید سولفوریک', annualAcidTon, 'تن') +
                createResultCard('مصرف روزانه اسید سولفوریک', dailyAcidTon, 'تن');

            resultsDiv.classList.remove('hidden');
        }
        
        // --- Tab Switching Logic ---
        const tabsContainer = document.getElementById('tabs');
        const tabContentContainer = document.getElementById('tab-content-container');
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                tabContentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                e.target.classList.add('active');
                const tabName = e.target.getAttribute('data-tab');
                document.getElementById(tabName).classList.add('active');
            }
        });

        calculateBtn.addEventListener('click', performCalculations);
        window.onload = populateAssumptions;
    </script>
</body>
</html>

نکات کلیدی و تغییرات اعمال شده
 * منطق معکوس (مبتنی بر تولید): محاسبات از هدف نهایی (تولید کاتد) آغاز می‌شود. با در نظر گرفتن راندمان‌های لیچینگ و SX/EW، میزان مس مورد نیاز در خوراک و در نتیجه، حجم کل کانسنگ لازم برای رسیدن به آن هدف تولیدی محاسبه می‌گردد.
 * سلول‌های الکترووینینگ استاندارد: تعداد سلول‌ها دقیقاً بر اساس فرض 30 کاتد در هر سلول محاسبه می‌شود که مطابق با درخواست شما و استانداردهای رایج صنعتی است.
 * جریان محلول (PLS): دبی محلول باردار (PLS) دیگر یک فرض ثابت نیست، بلکه بر اساس میزان مس که باید روزانه از هیپ به کارخانه SX منتقل شود و اختلاف غلظت مس در محلول ورودی (PLS) و خروجی (رافینت) محاسبه می‌گردد. این رویکرد بسیار دقیق‌تر است.
 * به‌روزرسانی مفروضات: پارامترهایی مانند عیار مس در رافینت به مفروضات اضافه شده و مقادیر دیگر (مانند نرخ پاشش و چرخه لیچینگ) برای انطباق با سناریوهای واقعی بهینه‌سازی شده‌اند.
 * دسته‌بندی جدید نتایج: نتایج در تب‌های منطقی‌تری سازماندهی شده‌اند تا تحلیل داده‌ها ساده‌تر باشد:
   * خلاصه فرآیند: نمایش میزان خوراک مورد نیاز برای رسیدن به تولید هدف.
   * سنگ‌شکنی و هیپ: ابعاد و ظرفیت‌های بخش آماده‌سازی و دپوی ماده معدنی.
   * کارخانه SX/EW: مشخصات کلیدی بخش فرآوری محلول و تولید کاتد.
   * مواد مصرفی: برآورد نیاز به مواد شیمیایی اصلی بر اساس حجم واقعی کانسنگ.
این نسخه از ماشین حساب، ابزار قدرتمندتری برای مطالعات امکان‌سنجی (Feasibility Study) و طراحی مفهومی (Conceptual Design) در اختیار شما قرار می‌دهد. امیدوارم این مدل جدید، نیازهای شما را به شکل کامل‌تری پوشش دهد.

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">که
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آنالیز دانه بندی سنگ شکن</title>
    <!-- اتصال به Tailwind CSS برای استایل‌دهی -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- اتصال به کتابخانه Chart.js برای رسم نمودار -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- اتصال به کتابخانه chartjs-plugin-zoom برای زوم نمودار -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        /* استایل‌های سفارشی */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            touch-action: manipulation; /* بهبود تجربه لمسی در موبایل */
        }
        .btn {
            @apply w-full sm:w-auto text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-green-600 hover:bg-green-700;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700;
        }
        .btn-disabled {
            @apply bg-gray-400 cursor-not-allowed;
        }
        #resultsContainer {
            scroll-behavior: smooth;
        }
        /* استایل برای نمایش بهتر دوربین */
        video, canvas {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        /* استایل برای مودال خطا */
        .modal-overlay {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300;
        }
        .modal-content {
            @apply bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 transform transition-transform duration-300 scale-95;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 max-w-4xl">
        <header class="text-center my-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">آنالیز دانه بندی محصول سنگ شکن</h1>
            <p class="mt-2 text-lg">با استفاده از دوربین گوشی و پردازش تصویر</p>
        </header>

        <main>
            <!-- بخش راهنما و تنظیمات اولیه -->
            <div id="setup-section" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">مراحل انجام کار</h2>
                <ol class="list-decimal list-inside space-y-3">
                    <li>سنگ‌ها را روی یک سطح صاف با رنگ متضاد (ترجیحاً سفید یا تیره یکدست) پخش کنید تا از هم جدا باشند.</li>
                    <li>یک سکه یا شیء دایره‌ای با اندازه مشخص به عنوان مقیاس کنار سنگ‌ها قرار دهید.</li>
                    <li>قطر سکه (به میلی‌متر) را در کادر زیر وارد کنید.</li>
                    <li>روی دکمه "شروع دوربین" کلیک کنید و به دوربین اجازه دسترسی بدهید.</li>
                    <li>کادر دوربین را طوری تنظیم کنید که هم سنگ‌ها و هم سکه به وضوح دیده شوند. سپس عکس بگیرید.</li>
                    <li>پس از گرفتن عکس، روی دکمه "شروع آنالیز" کلیک کنید.</li>
                </ol>
                <div class="mt-4 p-3 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg">
                    <p><strong>نکته مهم:</strong> برای دسترسی به دوربین، این صفحه باید روی یک سرور امن (HTTPS) اجرا شود. اجرای مستقیم فایل از روی حافظه دستگاه ممکن است کار نکند.</p>
                </div>
                <div class="mt-6">
                    <label for="coin-diameter" class="block mb-2 font-medium">قطر سکه (به میلی‌متر):</label>
                    <input type="number" id="coin-diameter" value="23.5" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                 <div class="mt-6 text-center">
                    <button id="start-camera-btn" class="btn btn-primary">۱. شروع دوربین</button>
                </div>
            </div>

            <!-- بخش دوربین و تصویر -->
            <div id="camera-section" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <div class="relative">
                    <video id="video" playsinline autoplay class="w-full h-auto rounded-lg"></video>
                    <canvas id="canvas" class="hidden absolute top-0 left-0 w-full h-auto rounded-lg"></canvas>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <button id="capture-btn" class="btn btn-secondary">۲. عکس بگیر</button>
                    <button id="analyze-btn" class="btn btn-primary btn-disabled" disabled>۳. شروع آنالیز</button>
                    <button id="reset-btn" class="btn btn-danger">ریست</button>
                </div>
            </div>

            <!-- بخش نتایج -->
            <div id="results-section" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-semibold mb-4 text-center">نتایج آنالیز</h2>
                 <div id="status" class="text-center my-4 p-3 rounded-lg bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200">
                    در حال پردازش... لطفاً منتظر بمانید.
                 </div>
                 <div class="mb-6">
                    <canvas id="result-chart"></canvas>
                 </div>
                 <div>
                    <h3 class="text-xl font-semibold mb-2">جدول توزیع اندازه دانه‌ها</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white dark:bg-gray-700 border rounded-lg">
                            <thead class="bg-gray-200 dark:bg-gray-600">
                                <tr>
                                    <th class="py-2 px-4 border-b">اندازه الک (mm)</th>
                                    <th class="py-2 px-4 border-b">درصد عبوری (Passing %)</th>
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- ردیف‌های جدول به صورت پویا اضافه می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- مودال نمایش خطا -->
    <div id="error-modal" class="modal-overlay hidden opacity-0">
        <div class="modal-content opacity-0">
            <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4">خطا</h3>
            <p id="error-message" class="mb-6"></p>
            <button id="close-modal-btn" class="btn btn-primary w-full">متوجه شدم</button>
        </div>
    </div>

<script>
// --- دریافت المان‌های DOM ---
const setupSection = document.getElementById('setup-section');
const cameraSection = document.getElementById('camera-section');
const resultsSection = document.getElementById('results-section');
const startCameraBtn = document.getElementById('start-camera-btn');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('capture-btn');
const analyzeBtn = document.getElementById('analyze-btn');
const resetBtn = document.getElementById('reset-btn');
const coinDiameterInput = document.getElementById('coin-diameter');
const statusDiv = document.getElementById('status');
const resultChartCanvas = document.getElementById('result-chart');
const resultTableBody = document.getElementById('result-table-body');
const context = canvas.getContext('2d', { willReadFrequently: true });
const errorModal = document.getElementById('error-modal');
const errorMessage = document.getElementById('error-message');
const closeModalBtn = document.getElementById('close-modal-btn');
let stream;
let chart;

// --- تعریف توابع ---

/**
 * @brief نمایش مودال خطا با پیام مشخص
 */
function showErrorModal(message, title = "خطا در دسترسی به دوربین") {
    errorModal.querySelector('h3').textContent = title;
    errorMessage.textContent = message;
    errorModal.classList.remove('hidden');
    setTimeout(() => {
        errorModal.classList.remove('opacity-0');
        errorModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
    }, 10);
}

/**
 * @brief پنهان کردن مودال خطا
 */
function hideErrorModal() {
    errorModal.classList.add('opacity-0');
    errorModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
    setTimeout(() => {
        errorModal.classList.add('hidden');
    }, 300);
}

/**
 * @brief شروع به کار دوربین
 */
async function startCamera() {
    startCameraBtn.disabled = true;
    startCameraBtn.textContent = 'در حال باز کردن دوربین...';
    startCameraBtn.classList.add('btn-disabled');

    try {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error("API دوربین در این مرورگر پشتیبانی نمی‌شود.");
        }
        const constraints = {
            video: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.classList.remove('hidden');
        canvas.classList.add('hidden');
        setupSection.classList.add('hidden');
        cameraSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('btn-disabled');
        captureBtn.disabled = false;
        captureBtn.classList.remove('btn-disabled');
    } catch (err) {
        console.error("خطا در دسترسی به دوربین: ", err);
        let message = "یک خطای ناشناخته رخ داد.";
        if (err.name === "NotAllowedError") {
            message = "شما اجازه دسترسی به دوربین را ندادید. لطفاً مجوز لازم را در تنظیمات مرورگر خود فعال کنید.";
        } else if (err.name === "NotFoundError") {
            message = "هیچ دوربین پشتی بر روی دستگاه شما پیدا نشد.";
        } else if (err.name === "NotReadableError") {
            message = "دوربین توسط یک برنامه دیگر در حال استفاده است یا یک مشکل سخت‌افزاری وجود دارد.";
        } else if (err.name === "SecurityError" || err.name === "TypeError") {
            message = "دسترسی به دوربین به دلایل امنیتی مسدود شده است. لطفاً مطمئن شوید که صفحه از طریق یک اتصال امن (HTTPS) بارگیری شده است.";
        }
        showErrorModal(message);
    } finally {
        startCameraBtn.disabled = false;
        startCameraBtn.textContent = '۱. شروع دوربین';
        startCameraBtn.classList.remove('btn-disabled');
    }
}

/**
 * @brief گرفتن عکس از ویدیو و نمایش آن روی بوم
 */
function captureImage() {
    try {
        // بررسی می‌کند که آیا ویدیو ابعاد معتبر دارد یا خیر
        if (!video.videoWidth || !video.videoHeight) {
            showErrorModal("ابعاد ویدیو هنوز در دسترس نیست. لطفاً لحظه‌ای صبر کرده و دوباره امتحان کنید.", "خطا در عکس‌برداری");
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        video.classList.add('hidden');
        canvas.classList.remove('hidden');

        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        // فعال کردن دکمه آنالیز و غیرفعال کردن دکمه عکس‌برداری
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('btn-disabled');
        captureBtn.disabled = true;
        captureBtn.classList.add('btn-disabled');
        
    } catch (err) {
        console.error("خطا در گرفتن عکس: ", err);
        showErrorModal(`خطایی در هنگام گرفتن عکس رخ داد: ${err.message}`, "خطا در عکس‌برداری");
    }
}

/**
 * @brief ریست کردن برنامه به حالت اولیه
 */
function resetApp() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    setupSection.classList.remove('hidden');
    cameraSection.classList.add('hidden');
    resultsSection.classList.add('hidden');
    
    video.classList.remove('hidden');
    canvas.classList.add('hidden');
    context.clearRect(0, 0, canvas.width, canvas.height);

    captureBtn.disabled = false;
    captureBtn.classList.remove('btn-disabled');
    analyzeBtn.disabled = true;
    analyzeBtn.classList.add('btn-disabled');

    if (chart) {
        chart.destroy();
    }
    resultTableBody.innerHTML = '';
    hideErrorModal();
}

/**
 * @brief تابع اصلی برای آنالیز تصویر
 */
function analyzeImage() {
    if (canvas.width === 0 || canvas.height === 0) {
        showErrorModal("لطفاً ابتدا یک عکس بگیرید.", "خطای آنالیز");
        return;
    }
    resultsSection.classList.remove('hidden');
    window.scrollTo({ top: resultsSection.offsetTop, behavior: 'smooth' });
    statusDiv.textContent = 'در حال پردازش... این فرآیند ممکن است چند لحظه طول بکشد.';
    statusDiv.className = 'text-center my-4 p-3 rounded-lg bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
    statusDiv.classList.remove('hidden');

    setTimeout(() => {
        try {
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const { data, width, height } = imageData;

            const threshold = 120; 
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                const value = gray < threshold ? 0 : 255;
                data[i] = data[i + 1] = data[i + 2] = value;
            }

            const labels = findComponents(imageData);
            const componentAreas = calculateAreas(labels);

            const coinDiameterMM = parseFloat(coinDiameterInput.value);
            if (isNaN(coinDiameterMM) || coinDiameterMM <= 0) {
                throw new Error("مقدار قطر سکه نامعتبر است.");
            }
            
            let coinComponentIndex = -1;
            let maxArea = 0;
            componentAreas.forEach((area, index) => {
                if (area > maxArea) {
                    maxArea = area;
                    coinComponentIndex = index;
                }
            });

            if (coinComponentIndex === -1 || maxArea < 100) {
                throw new Error("سکه در تصویر پیدا نشد. لطفاً مطمئن شوید سکه به وضوح در تصویر مشخص است و رنگ آن با پس‌زمینه تضاد دارد.");
            }
            
            const coinAreaPixels = maxArea;
            const pixelsPerMm2 = coinAreaPixels / (Math.PI * Math.pow(coinDiameterMM / 2, 2));

            const particleSizesMM = [];
            componentAreas.forEach((area, index) => {
                if (index !== coinComponentIndex && area > 20) {
                    const areaMM2 = area / pixelsPerMm2;
                    const equivalentDiameter = Math.sqrt(4 * areaMM2 / Math.PI);
                    particleSizesMM.push(equivalentDiameter);
                }
            });

            if (particleSizesMM.length === 0) {
                throw new Error("هیچ سنگی برای آنالیز پیدا نشد. لطفاً از تضاد کافی بین سنگ‌ها و پس‌زمینه اطمینان حاصل کنید.");
            }
            
            displayResults(particleSizesMM);

            statusDiv.textContent = `آنالیز با موفقیت انجام شد. ${particleSizesMM.length} سنگ شناسایی شد.`;
            statusDiv.className = 'text-center my-4 p-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';

        } catch (e) {
            console.error("خطا در آنالیز تصویر:", e);
            statusDiv.textContent = `خطا: ${e.message}`;
            statusDiv.className = 'text-center my-4 p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
        }
    }, 100);
}

/**
 * @brief الگوریتم ساده برای پیدا کردن اجزای متصل
 */
function findComponents(imageData) {
    const { data, width, height } = imageData;
    const labels = new Uint32Array(width * height);
    let nextLabel = 1;
    const q = [];

    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            const i = (y * width + x);
            if (data[i*4] === 0 && labels[i] === 0) {
                q.length = 0;
                q.push(i);
                labels[i] = nextLabel;
                let head = 0;
                while(head < q.length){
                    const current = q[head++];
                    const cx = current % width;
                    const cy = Math.floor(current / width);
                    for(let ny = cy - 1; ny <= cy + 1; ny++){
                        for(let nx = cx - 1; nx <= cx + 1; nx++){
                            if(nx >= 0 && nx < width && ny >= 0 && ny < height){
                                const neighborIndex = ny * width + nx;
                                if(data[neighborIndex*4] === 0 && labels[neighborIndex] === 0){
                                    labels[neighborIndex] = nextLabel;
                                    q.push(neighborIndex);
                                }
                            }
                        }
                    }
                }
                nextLabel++;
            }
        }
    }
    return labels;
}

/**
 * @brief محاسبه مساحت هر جزء
 */
function calculateAreas(labels) {
    const areas = new Map();
    for (let i = 0; i < labels.length; i++) {
        const label = labels[i];
        if (label > 0) {
            areas.set(label, (areas.get(label) || 0) + 1);
        }
    }
    return areas;
}

/**
 * @brief نمایش نتایج در نمودار و جدول
 */
function displayResults(sizes) {
    const sieveSizes = [75, 63, 50, 37.5, 25, 19, 12.5, 9.5, 4.75, 2.36, 1.18, 0.6, 0.3, 0.15, 0.075];
    sieveSizes.sort((a, b) => b - a);

    const totalParticles = sizes.length;
    let passingPercentages = [];

    sieveSizes.forEach(sieveSize => {
        const passingCount = sizes.filter(particleSize => particleSize <= sieveSize).length;
        const passingPercent = (passingCount / totalParticles) * 100;
        passingPercentages.push(passingPercent);
    });
    
    resultTableBody.innerHTML = '';
    if (chart) {
        chart.destroy();
    }

    sieveSizes.forEach((size, index) => {
        const row = `<tr>
            <td class="py-2 px-4 border-b text-center">${size}</td>
            <td class="py-2 px-4 border-b text-center">${passingPercentages[index].toFixed(2)}%</td>
        </tr>`;
        resultTableBody.innerHTML += row;
    });

    const chartData = {
        labels: sieveSizes.map(String),
        datasets: [{
            label: 'درصد عبوری (Passing %)',
            data: passingPercentages,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            fill: true,
            tension: 0.1
        }]
    };

    chart = new Chart(resultChartCanvas, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'نمودار منحنی دانه‌بندی', font: { size: 18 } },
                legend: { position: 'top' },
                zoom: {
                    zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
                    pan: { enabled: true, mode: 'x' }
                }
            },
            scales: {
                x: {
                    type: 'logarithmic',
                    title: { display: true, text: 'اندازه الک (mm) - مقیاس لگاریتمی' },
                    reverse: true
                },
                y: {
                    title: { display: true, text: 'درصد عبوری' },
                    min: 0,
                    max: 100
                }
            }
        }
    });
}

// --- اتصال Event Listeners ---
startCameraBtn.addEventListener('click', startCamera);
captureBtn.addEventListener('click', captureImage);
analyzeBtn.addEventListener('click', analyzeImage);
resetBtn.addEventListener('click', resetApp);
closeModalBtn.addEventListener('click', hideErrorModal);
errorModal.addEventListener('click', (e) => {
    if (e.target === errorModal) {
        hideErrorModal();
    }
});

</script>

</body>
</html>
